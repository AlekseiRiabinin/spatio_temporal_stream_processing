networks:
  kafka-net:
    driver: bridge

volumes:
  postgis-cre-data:
    name: postgis-cre-data
  redis-cre-data:
    name: redis-cre-data

services:

  # ============================================================
  # 1. EVENT TRANSPORT LAYER (Kafka = streams model)
  # ============================================================

  kafka-1:
    image: bitnami/kafka:3.8.0
    container_name: kafka-1
    ports:
      - "19092:19092"
      - "19093:19093"
    environment:
      - KAFKA_ENABLE_KRAFT=yes
      - KAFKA_KRAFT_CLUSTER_ID=d8ce1515-401e-44d4-a444-1b6dba479047
      - ALLOW_PLAINTEXT_LISTENER=yes
      - KAFKA_HEAP_OPTS=-Xmx2G -Xms2G
    volumes:
      - ./kafka/server-1.properties:/opt/bitnami/kafka/config/server.properties:ro
    networks: [kafka-net]
    restart: always

  kafka-2:
    image: bitnami/kafka:3.8.0
    container_name: kafka-2
    ports:
      - "19094:19094"
      - "19095:19095"
    environment:
      - KAFKA_ENABLE_KRAFT=yes
      - KAFKA_KRAFT_CLUSTER_ID=d8ce1515-401e-44d4-a444-1b6dba479047
      - ALLOW_PLAINTEXT_LISTENER=yes
    volumes:
      - ./kafka/server-2.properties:/opt/bitnami/kafka/config/server.properties:ro
    networks: [kafka-net]
    restart: always


  # ============================================================
  # 2. GEO DATA PRODUCER (standalone service)
  # ============================================================

  geo_producer_architecture:
    build:
      context: ../data-generators/article-01-geo-producer
      dockerfile: Dockerfile
    container_name: geo_producer_architecture
    depends_on:
      - kafka-1
      - kafka-2
    environment:
      KAFKA_BOOTSTRAP_SERVERS: "kafka-1:19092,kafka-2:19094"
      KAFKA_TOPIC: "spatial-events"
      EVENT_RATE: "100"    
    networks: [kafka-net]
    restart: unless-stopped


  # ============================================================
  # 3. STREAM PROCESSING LAYER (Flink + GeoFlink)
  # ============================================================

  jobmanager:
    image: flink:1.17.1
    container_name: jobmanager
    ports:
      - "8081:8081"
    volumes:
      - ./flink/flink-conf.yaml:/opt/flink/conf/flink-conf.yaml
    command: jobmanager
    networks: [kafka-net]

  taskmanager:
    image: flink:1.17.1
    container_name: taskmanager
    depends_on: [jobmanager]
    volumes:
      - ./flink/flink-conf.yaml:/opt/flink/conf/flink-conf.yaml
    command: taskmanager
    networks: [kafka-net]

  geoflink_architecture_job:
    build:
      context: ../stream-processing/flink-jobs/article-01-architecture
      dockerfile: Dockerfile
    container_name: geoflink_architecture_job
    depends_on:
      - jobmanager
      - taskmanager
      - kafka-1
      - kafka-2
    environment:
      FLINK_MAIN_CLASS: "phd.architecture.Article01ArchitectureJob"
      FLINK_PARALLELISM: "1"
      MAX_OUT_OF_ORDERNESS: "5"
      GEOHASH_PRECISION: "6"
      WINDOW_SIZE: "30"
      WINDOW_SLIDE: "30"
    volumes:
      - ./flink/flink-conf.yaml:/opt/flink/conf/flink-conf.yaml
    networks: [kafka-net]
    restart: on-failure


  # ============================================================
  # 4. STORAGE LAYER (Materialized State)
  # ============================================================

  postgis-cre:
    image: postgis/postgis:18-3.6
    container_name: postgis-cre
    ports:
      - "5435:5432"
    environment:
      POSTGRES_DB: cre_db
      POSTGRES_USER: cre_user
      POSTGRES_PASSWORD: cre_password
    volumes:
      - postgis-cre-data:/var/lib/postgresql
      - ./postgis/init.sql:/docker-entrypoint-initdb.d/init.sql:ro
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U cre_user -d cre_db"]
      interval: 5s
      timeout: 5s
      retries: 10
    networks: [kafka-net]
    restart: always

  redis-cre:
    image: redis:7.2-alpine
    container_name: redis-cre
    volumes:
      - redis-cre-data:/data
    networks: [kafka-net]
    restart: always


  # ============================================================
  # 5. VISUALIZATION & ACCESS
  # ============================================================

  tegola-cre:
    image: gospatial/tegola:v0.21.2
    container_name: tegola-cre
    restart: unless-stopped
    depends_on:
      postgis-cre:
        condition: service_healthy
      redis-cre:
        condition: service_healthy
    volumes:
      - ./tegola/config/config.toml:/config/config.toml:ro
      - ./tegola/styles:/styles:ro
    entrypoint: ["/opt/tegola", "serve", "--config", "/config/config.toml", "--port", ":8085"]
    ports:
      - "8085:8085"
    environment:
      TEGOLA_MAX_TILE_SIZE: "10MB"
      TEGOLA_CACHE_TYPE: "redis"
      TEGOLA_CACHE_REDIS_ENDPOINT: "redis-cre:6379"
      TEGOLA_CACHE_REDIS_PREFIX: "tegola:"
    networks:
      - kafka-net

  pgadmin-cre:
    image: dpage/pgadmin4
    container_name: pgadmin-cre
    ports:
      - "5051:80"
    environment:
      PGADMIN_DEFAULT_EMAIL: admin@localhost.localdomain
      PGADMIN_DEFAULT_PASSWORD: admin
    depends_on: [postgis-cre]
    networks: [kafka-net]


# docker compose -f docker/docker-compose.yml up -d kafka-1 kafka-2
# ./scripts/test-geo-producer.sh
