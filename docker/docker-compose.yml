networks:
  kafka-net:
    driver: bridge

volumes:
  postgis-cre-data:
    name: postgis-cre-data
  redis-cre-data:
    name: redis-cre-data

services:

  # ============================================================
  # 1. EVENT TRANSPORT LAYER (Kafka = streams model)
  # ============================================================

  kafka-1:
    image: bitnami/kafka:3.8.0
    container_name: kafka-1
    ports:
      - "19092:19092"
      - "19093:19093"
    environment:
      - KAFKA_ENABLE_KRAFT=yes
      - KAFKA_KRAFT_CLUSTER_ID=d8ce1515-401e-44d4-a444-1b6dba479047
      - ALLOW_PLAINTEXT_LISTENER=yes
      - KAFKA_HEAP_OPTS=-Xmx2G -Xms2G
    volumes:
      - ./kafka/server-1.properties:/opt/bitnami/kafka/config/server.properties:ro
    networks: [kafka-net]
    restart: always


  # ============================================================
  # 2. GEO DATA PRODUCER (standalone service)
  # ============================================================

  geo_producer_architecture:
    build:
      context: ../data-generators/article-01-geo-producer
      dockerfile: Dockerfile
    container_name: geo_producer_architecture
    depends_on:
      - kafka-1
    environment:
      KAFKA_BOOTSTRAP_SERVERS: "kafka-1:19092"
      KAFKA_TOPIC: "spatial-events"
      EVENT_RATE: "100"    
    networks: [kafka-net]
    restart: unless-stopped


  # ============================================================
  # 3. STREAM PROCESSING LAYER (Flink + GeoFlink)
  # ============================================================

  jobmanager:
    image: flink:1.17.1
    container_name: jobmanager
    hostname: jobmanager
    ports:
      - "8081:8081"
      - "9249:9249"
    environment:
      FLINK_PROPERTIES: |
        jobmanager.rpc.address: jobmanager
        jobmanager.memory.process.size: 1600m
        taskmanager.memory.process.size: 1728m
        taskmanager.numberOfTaskSlots: 1
        rest.port: 8081
        rest.address: jobmanager
        metrics.reporters: prom
        metrics.reporter.prom.class: org.apache.flink.metrics.prometheus.PrometheusReporter
        metrics.reporter.prom.factory.class: org.apache.flink.metrics.prometheus.PrometheusReporterFactory
        metrics.reporter.prom.port: 9249
    command: jobmanager
    volumes:
      - ../stream-processing/flink-jobs/article-01-architecture/target/scala-2.12/article-01-architecture.jar:/opt/flink/usrlib/article-01-architecture.jar
      - ./flink/flink-connector-kafka-3.0.0-1.17.jar:/opt/flink/lib/flink-connector-kafka-3.0.0-1.17.jar
      - ./flink/kafka-clients-3.7.0.jar:/opt/flink/lib/kafka-clients-3.7.0.jar
      - ./flink/flink-metrics-prometheus-1.17.1.jar:/opt/flink/lib/flink-metrics-prometheus-1.17.1.jar
    networks: [kafka-net]

  taskmanager:
    image: flink:1.17.1
    container_name: taskmanager
    hostname: taskmanager
    ports:
      - "9250:9249"
    depends_on: [jobmanager]
    environment:
      FLINK_PROPERTIES: |
        jobmanager.rpc.address: jobmanager
        jobmanager.memory.process.size: 1600m
        taskmanager.memory.process.size: 1728m
        taskmanager.numberOfTaskSlots: 1
        rest.port: 8081
        rest.address: jobmanager
        metrics.reporters: prom
        metrics.reporter.prom.class: org.apache.flink.metrics.prometheus.PrometheusReporter
        metrics.reporter.prom.factory.class: org.apache.flink.metrics.prometheus.PrometheusReporterFactory
        metrics.reporter.prom.port: 9249
    command: taskmanager
    volumes:
      - ./flink/flink-connector-kafka-3.0.0-1.17.jar:/opt/flink/lib/flink-connector-kafka-3.0.0-1.17.jar
      - ./flink/kafka-clients-3.7.0.jar:/opt/flink/lib/kafka-clients-3.7.0.jar
      - ./flink/flink-metrics-prometheus-1.17.1.jar:/opt/flink/lib/flink-metrics-prometheus-1.17.1.jar
    networks: [kafka-net]

  geoflink_architecture_job:
    image: flink:1.17.1
    depends_on: [jobmanager]
    environment:
      FLINK_MAIN_CLASS: "phd.architecture.Article01ArchitectureJob"
      FLINK_PARALLELISM: "1"
      MAX_OUT_OF_ORDERNESS: "5"
      GEOHASH_PRECISION: "6"
      WINDOW_SIZE: "30"
      WINDOW_SLIDE: "30"
    volumes:
      - ../stream-processing/flink-jobs/article-01-architecture/target/scala-2.12/article-01-architecture.jar:/opt/flink/usrlib/article-01-architecture.jar
      - ./flink/flink-connector-kafka-3.0.0-1.17.jar:/opt/flink/lib/flink-connector-kafka-3.0.0-1.17.jar
      - ./flink/kafka-clients-3.7.0.jar:/opt/flink/lib/kafka-clients-3.7.0.jar
    command: >
      flink run
      -c phd.architecture.Article01ArchitectureJob
      -m jobmanager:8081
      /opt/flink/usrlib/article-01-architecture.jar
    networks: [kafka-net]
    restart: "no"


  # ============================================================
  # 4. STORAGE LAYER (Materialized State)
  # ============================================================

  postgis-cre:
    image: postgis/postgis:18-3.6
    container_name: postgis-cre
    ports:
      - "5435:5432"
    environment:
      POSTGRES_DB: cre_db
      POSTGRES_USER: cre_user
      POSTGRES_PASSWORD: cre_password
    volumes:
      - postgis-cre-data:/var/lib/postgresql
      - ./postgis/init.sql:/docker-entrypoint-initdb.d/init.sql:ro
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U cre_user -d cre_db"]
      interval: 5s
      timeout: 5s
      retries: 10
    networks: [kafka-net]
    restart: always

  redis-cre:
    image: redis:7.2-alpine
    container_name: redis-cre
    volumes:
      - redis-cre-data:/data
    networks: [kafka-net]
    restart: always


  # ============================================================
  # 5. VISUALIZATION & ACCESS
  # ============================================================

  prometheus:
    image: prom/prometheus
    container_name: prometheus
    ports:
      - "9091:9090"
    volumes:
      - ./prometheus/prometheus.yml:/etc/prometheus/prometheus.yml
    networks: [kafka-net]
    restart: always

  kafdrop:
    image: obsidiandynamics/kafdrop:3.30.0
    container_name: kafdrop
    ports:
      - "9003:9000"
    environment:
      KAFKA_BROKERCONNECT: "kafka-1:19092"
    depends_on:
      - kafka-1
    networks:
      - kafka-net
    restart: always

  tegola-cre:
    image: gospatial/tegola:v0.21.2
    container_name: tegola-cre
    restart: unless-stopped
    depends_on:
      postgis-cre:
        condition: service_healthy
      redis-cre:
        condition: service_healthy
    volumes:
      - ./tegola/config/config.toml:/config/config.toml:ro
      - ./tegola/styles:/styles:ro
    entrypoint: ["/opt/tegola", "serve", "--config", "/config/config.toml", "--port", ":8085"]
    ports:
      - "8085:8085"
    environment:
      TEGOLA_MAX_TILE_SIZE: "10MB"
      TEGOLA_CACHE_TYPE: "redis"
      TEGOLA_CACHE_REDIS_ENDPOINT: "redis-cre:6379"
      TEGOLA_CACHE_REDIS_PREFIX: "tegola:"
    networks:
      - kafka-net

  pgadmin-cre:
    image: dpage/pgadmin4
    container_name: pgadmin-cre
    ports:
      - "5051:80"
    environment:
      PGADMIN_DEFAULT_EMAIL: admin@localhost.localdomain
      PGADMIN_DEFAULT_PASSWORD: admin
    depends_on: [postgis-cre]
    networks: [kafka-net]


# docker compose -f docker/docker-compose.yml up -d kafka-1
# ./scripts/test-geo-producer.sh
